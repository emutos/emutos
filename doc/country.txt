
country.txt - an overview of i18n issues in EMuTOS

EmuTOS supports different countries. The way it does is sometimes
dictated by TOS specifications, and sometimes solved in original
ways. 

What can vary
-------------

- language: messages printed by EmuTOS, see doc/nls.txt
- keyboard: the rules to convert from scancodes to characters
- charset: a way of encoding characters
- font: the graphical display of individual characters
- date&time: the way of printing time-related info in text.

in EmuTOS, we shall call 'country' a community having the same value 
for all the parameters above. This means that Switzerland(German) and
Switzerland(French) are not the same 'country' because the language and
keyboards are different.

Obviously these things are related. For instance, the language, 
keyboard and font depend on the charset.

Where is it in the code
-----------------------

- language: this is covered by the 'nls' stuff, in files
  util/langs.[ch], util/nls.c, util/nlsasm.S

- keyboard: 
  bios/country.h holds #defines for the keyboard codes;
  bios/kbd_* contain the actual kbd layouts
  bios/country.c contains the logic to choose the keyboard to use.

- charset:
  bios/country.h holds #defines for the charset codes;

- font:
  bios/*6x6.c, bios/*8x8.c and bios/*8x16.c contain the fonts
  bios/country.c contains the logic to choose the fontsets to use.

- date&time:
  the cookie _IDT. Should be used by cli/command.c and bios/initinfo. 

How is it set?
--------------

bios/country.c contains the values of language, keyboard, charset and
IDT for each known country.

function detect_akp_idt() is called early in the boot sequence (from
detect(), when filling the cookie jar). See in bios.c:

  cookie_init();  /* sets a cookie jar */
  machine_init(); /* detect hardware features and fill the cookie jar */

If an NVRAM is found, then the time&date, keyboard, language and 
country are taken from it, and the charset is deduced from the
language. Else the country code is taken from the OS header, and 
all parameters are deduced from the country code. Parameters in
the OS header are set by the Makefile (tool mkheader), depending on 
the value of the config variable $(COUNTRY).
  
Later, nls is inited and configured according to the language.
See in bios.c:

  nls_init();         /* init native language support */
  nls_set_lang(get_lang_name());

Here, function get_lang_name() is the method from country.c to obtain 
the language name.

New country check list
----------------------

- if the country is not known (in bios/country.h),
  - add a code in bios/country.h and in tools/mkheader.c
- add a line in the table in bios/country.c
- if a specific charset is needed, 
  - add a line in the charset table in bios/country.h
  - provide C source code fonts for this charset (you may use 
    tool fntconv to create the C files, available from Laurent's 
    page at http://lvogel.free.fr).
    => IMPORTANT NOTICE: the GEM will crash if the values in the 
    => font header are not as follow: 
    =>    font_id = 1
    =>    flags = F_STDFORM | F_DEFAULT | F_MONOSPACE
  - add the new C source codes to the Makefile
  - update the font table in bios/country.c
  - check if this charset is known by GNU recode and if not
    - send mail to the GNU recode maintainer (!)
  - see chapter 'charsets' of doc/nls.txt 
- if a specific keyboard is needed,
  - add it in bios/country.c (follow instructions there)
  - provide the keyboard layout in a file bios/keyb_*.h
- if a specific language is needed,
  - follow the instructions in doc/nls.txt

Note: adding a new charset makes it mandatory to also add a new keyboard
and a new language.
